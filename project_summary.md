# 統合工程管理システム 設計仕様書 (統合版)

## 1.0 概要

本システムは、建設業務における**「案件」「工程」「人員」**の情報を一元管理し、業務効率を飛躍的に向上させるための統合Webアプリケーションである。

従来、ホワイトボードやExcel、個人の手帳などで属人的かつ散在的に管理されていた情報を、単一のプラットフォームに集約する。特に、会社の全案件の進捗と、全作業員の日々の稼働状況を、**俯瞰的な視点から一目で把握できる「全体工程管理ボード」**をシステムの核とする。

これにより、無駄のない人員配置、正確な原価管理、そして迅速な意思決定を実現し、会社の生産性を最大化することを目的とする。

## 2.0 機能要件

### 2.1 全体工程管理ボード

本システムの最重要機能。単一のタイムライン画面上で、以下の情報を統合的に表示・操作する。

#### 2.1.1 表示要件

1.  **基本構造:**
    * 単一のタイムラインカレンダーで、左側にリソース（縦軸）、右側に時間軸（横軸）を表示する。
    * 画面全体の縦横スクロールは完全に同期し、表示のズレは発生しない。

2.  **リソースエリア（縦軸）:**
    * リソースは「工程」「人員」の2つのグループに大別される。
    * **工程グループ:** 会社の全案件名を親階層とし、各案件に紐づく作業項目（足場設置、高圧洗浄など）を子階層としてツリー表示する。
    * **人員グループ:** 会社の全作業員名を一覧表示する。

3.  **タイムラインエリア（横軸）:**
    * **全体工期バー:** 各案件（親階層）の行に、案件の開始日から終了日までを示すバーを表示する。バーには「`[現場名] (M/D～M/D 〇日間)`」の形式で情報を表示する。
    * **作業項目バー:** 各作業項目（子階層）の行に、その作業の期間を示すバーを表示する。
    * **人員配置予定:** 各作業員の行に、その日に担当する現場名（案件名）を示すブロックを表示する。1日に複数の現場を担当する場合は、1つのセル内に複数のブロックを分割して表示する（最大4件まで）。

#### 2.1.2 操作要件

1.  **工程バーの操作:**
    * 全体工期バーおよび作業項目バーは、左右へのドラッグによる日付移動、およびバーの端を伸縮させることによる期間変更を可能とする。
    * これらの操作は、即座にデータベース（`Projects`, `ProjectTasks`テーブル）の`startDate`, `endDate`に反映される。
    * 上下の異なるリソース行への移動は禁止する。

2.  **人員配置の操作:**
    * **新規追加:** 工程表の**全体工期バー**を掴み、下の人員配置エリアの任意の作業員・日付のセルにドラッグ＆ドロップすることで、新しい人員配置を作成する。この際、その案件の最初の作業項目が自動で紐づけられる。
    * **変更:** 既に配置されている予定ブロックは、別の作業員や別の日付へドラッグ＆ドロップで自由に変更できる。
    * これらの操作は、即座にデータベース（`Assignments`テーブル）に反映される。

3.  **リソースの並び替え:**
    * 左側の案件名および作業員名は、ドラッグ＆ドロップで上下に並び替えが可能。
    * 変更された順番はデータベース（`Projects`, `Workers`テーブル）の`order`カラムに保存され、永続化される。

#### 2.1.3 UI補助機能

1.  **表示期間の制御:**
    * 「週」「月」「年」の表示切り替えは廃止し、より直感的な「＋（拡大）」「－（縮小）」ボタンを設置する。

2.  **日付のハイライト:**
    * 土曜日の列は薄い青系、日曜日および祝日の列は薄い赤系で背景色を色分けし、視認性を高める。
    * 日本の祝日は`@holiday-jp/holiday_jp`ライブラリを利用して判定する。
    * 画面表示時、初期スクロール位置は「今日」の日付が左端に表示されるように調整する。

## 3.0 データベース設計 (Supabase / PostgreSQL)

### マスターデータ

マスタデータは、システムの基礎となる情報。

| データ名 | テーブル名 | データ構造（主なカラム） | 概要 |
| :--- | :--- | :--- | :--- |
| 顧客情報 | `Customers` | `id`, `name`, `address`, `contactPerson`, `phone` | 取引先の顧客情報を管理。 |
| 作業員情報 | `Workers` | `id`, `name`, `order`, `birthDate`, `hireDate`, `address`, `contactInfo`, `cpdsNumber`, `kana` | 社員の基本情報と表示順を管理。 |
| 材料マスター | `Materials` | `id`, `name`, `category`, `unit`, `unitPrice`, `colorInfo`, `packagingOptions` | 使用する材料の単価や荷姿を管理。 |
| サービスマスター | `ServiceMaster` | `id`, `name`, `category`, `defaultUnitPrice`, `unit` | 見積作成の基礎となる作業項目と標準単価を管理。 |
| 作業員資格 | `WorkerCertifications` | `id`, `workerId` (FK), `name`, `acquisitionDate`, `expiryDate` | 各作業員が保有する資格情報を管理。 |

### 業務データ

日々の業務で発生・更新されるデータ。

| データ名 | テーブル名 | データ構造（主なカラム） | 概要 |
| :--- | :--- | :--- | :--- |
| 工事案件 | `Projects` | `id`, `name`, `order`, `startDate`, `endDate`, `customerId` (FK), `status` | 工事案件の全体を管理。 |
| 案件作業項目 | `ProjectTasks`| `id`, `projectId` (FK), `serviceMasterId` (FK), `startDate`, `endDate`, `order`, `status` | 各案件内の具体的な作業工程を管理。 |
| 人員配置 | `Assignments` | `id`, `projectTaskId` (FK), `workerId` (FK), `date` | 「誰が」「いつ」「どの作業を」担当するかを記録。 |
| 日報（表紙） | `DailyReports`| `id`, `workerId` (FK), `date`, `weather`, `generalComments` | 日報のヘッダー情報。 |
| 作業時間記録 | `WorkLogs` | `id`, `dailyReportId` (FK), `projectTaskId` (FK), `startTime`, `endTime` | 日報内の具体的な作業時間を記録。 |
| 材料使用記録 | `MaterialUsageLogs` | `id`, `dailyReportId` (FK), `materialId` (FK), `quantityUsed` | 日報内で使用した材料を記録。 |

*(FK) = 外部キー*

## 4.0 実装概要とファイル構成

### 4.1 実装概要

フロントエンドには、モダンで高速な**React (TypeScript)とVite**を採用。UIの構築には**MUI**と**FullCalendar**を導入し、プロフェッショナルな見た目と機能を実現した。

* **基本構造の構築**
    * `Vite`によるReact(TypeScript)プロジェクトのセットアップ。
    * `supabaseClient.ts`を作成し、Supabaseバックエンドとの接続を確立。
    * `MUI`を使用し、ヘッダーとサイドバーを持つ基本的なアプリケーションレイアウト(`Layout.tsx`)を構築。
* **ページ遷移（ルーティング）の実装**
    * `react-router-dom`を導入。
    * 「ダッシュボード」「案件一覧」「工程管理」などのページを作成し、サイドバーから各ページへ遷移できるように`App.tsx`でルーティングを設定。
* **「全体工程管理ボード」の実装 (`OverallSchedulePage.tsx`)**
    * 本システムの**最重要機能**。
    * `FullCalendar`の`resourceTimeline`ビューを採用し、**全案件の工程**と**全作業員の人員配置**を、一つの画面で階層的に表示することに成功。
    * Supabaseから複数のテーブルのデータを非同期で取得し、カレンダーが表示できる形式に整形。
    * 人員配置の予定を**ドラッグ＆ドロップ**で変更すると、リアルタイムでSupabaseの`Assignments`テーブルが更新される機能を実装。
    * 土日祝日の色分け、案件ごとの全体工期バーと作業項目バーの表示分け、人員配置の複数予定表示など、きめ細やかな表示改善を実装済み。

### 4.2 ファイル構成

```
project-management-app/
├── node_modules/      // インストールしたライブラリ群
├── public/
│   └── vite.svg
├── src/
│   ├── pages/
│   │   ├── DashboardPage.tsx
│   │   ├── OverallSchedulePage.tsx  <-- 現在のメイン開発画面
│   │   ├── ProjectDetailPage.tsx    (旧画面、現在は未使用)
│   │   └── ProjectsPage.tsx
│   ├── App.tsx              // 全体のルーティングを管理
│   ├── Layout.tsx           // ヘッダーとサイドバーのレイアウト
│   ├── main.tsx             // アプリの起動点
│   ├── supabaseClient.ts    // Supabaseとの接続設定
│   └── index.css            // グローバルなCSS
├── .eslintrc.cjs
├── .gitignore
├── index.html             // アプリの土台となるHTML
├── package.json
├── package-lock.json
├── tsconfig.json
└── tsconfig.node.json
